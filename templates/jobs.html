{% extends 'base.html' %}

{% block head_extra %}
    <link rel="stylesheet" href="{{ url_for('static', filename='job_monitor.css') }}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <script type="module" src="{{ url_for('static', filename='js/jobs.js') }}"></script>
    <script type="module" src="{{ url_for('static', filename='js/job_monitor.js') }}"></script>
    <script type="module" src="{{ url_for('static', filename='js/ui_utils.js') }}"></script>
{% endblock %}

{% block content %}
<script>
// Inject jobs data into window.jobsData for jobs.js to use
window.jobsData = {{ jobs | tojson | safe }};
</script>

<div class="page-header">
  <h2>Jobs</h2>
  <p class="subtitle">Manage and monitor all jobs</p>
</div>

<div class="section-container">
  <div class="section-header">
    <h3>Jobs Table</h3>
  </div>
    <div class="controls-row">
      <div class="filter-controls">
        <button id="refresh-jobs" class="action-button secondary">
          <i class="fas fa-sync-alt"></i>
          <span>Refresh</span>
        </button>
      </div>
    </div>
  <div class="table-container">
    <table id="jobs-table" class="data-table">
      <thead>
        <tr>
          <th data-sort="id" class="sort-desc col-id">ID</th>
          <th data-sort="name" class="col-name">Name</th>
          <th data-sort="status" class="col-status">Status</th>
          <th data-sort="type" class="col-type">Type</th>
          <th data-sort="progress" class="col-progress">Progress</th>
          <th data-sort="creation_time" class="col-created">Created</th>
          <th class="col-actions">Actions</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td colspan="7" class="loading-message">
            <div class="loading-spinner"></div>
            <span>Loading jobs...</span>
          </td>
        </tr>
      </tbody>
    </table>
  </div>

  <div class="pagination-controls">
    <button class="pagination-button" id="jobs-prev-page" disabled>
      <i class="fas fa-chevron-left"></i>
      <span>Previous</span>
    </button>
    <div class="pagination-info">
      Page <span id="jobs-current-page">1</span> of <span id="jobs-total-pages">1</span>
      <div class="select-wrapper display-count-wrapper">
        <select id="jobs-page-size" class="display-count-select">
          <option value="4">4</option>
          <option value="8" selected>8</option>
          <option value="12">12</option>
          <option value="16">16</option>
          <option value="24">24</option>
        </select>
        <span class="display-count-label">per page</span>
      </div>
    </div>
    <button class="pagination-button" id="jobs-next-page" disabled>
      <span>Next</span>
      <i class="fas fa-chevron-right"></i>
    </button>
  </div>
</div>

<!-- Confirmation Modal -->
<div id="confirm-modal" class="modal">
  <div class="modal-overlay"></div>
  <div class="modal-container modal-sm">
    <div class="modal-header">
      <h3>Confirm Action</h3>
      <button class="modal-close confirm-cancel">
        <i class="fas fa-times"></i>
      </button>
    </div>

    <div class="modal-body">
      <p id="confirm-message">Are you sure you want to perform this action?</p>
    </div>

    <div class="modal-footer">
      <button class="action-button secondary confirm-cancel">Cancel</button>
      <button id="confirm-action" class="action-button danger">Confirm</button>
    </div>
  </div>
</div>
<!-- Job Details Modal -->
<div id="job-details-modal" class="modal">
  <div class="modal-overlay"></div>
  <div class="modal-container">
    <div class="modal-header">
      <h3>Job Details</h3>
      <button id="close-job-details-modal" class="modal-close">
        <i class="fas fa-times"></i>
      </button>
    </div>

    <div class="modal-body">
      <div id="job-details-content">
        <div class="loading-message">
          <div class="loading-spinner"></div>
          <span>Loading job details...</span>
        </div>
      </div>

      <div id="job-details-error" class="error-message" style="display: none;">
        <i class="fas fa-exclamation-circle"></i>
        <span>Failed to load job details.</span>
      </div>

      <div id="job-details-container" style="display: none;">
        <!-- Tabs navigation -->
        <div class="tabs-container">
          <div class="tabs-nav">
            <button class="tab-button active" data-tab="basic-info">Basic Information</button>
            <button class="tab-button" data-tab="parameters">Parameters</button>
            <button class="tab-button" data-tab="files">Files</button>
          </div>

          <!-- Tab content -->
          <div class="tab-content" id="basic-info-tab">
            <table class="details-table">
              <tbody>
                <tr>
                  <th>Job ID</th>
                  <td id="job-id"></td>
                </tr>
                <tr>
                  <th>Job Name</th>
                  <td id="job-name"></td>
                </tr>
                <tr>
                  <th>Status</th>
                  <td id="job-status"></td>
                </tr>
                <tr>
                  <th>Type</th>
                  <td id="job-type"></td>
                </tr>
                <tr>
                  <th>Progress</th>
                  <td id="job-progress"></td>
                </tr>
                <tr>
                  <th>Created</th>
                  <td id="job-created"></td>
                </tr>
                <tr>
                  <th>Started</th>
                  <td id="job-started"></td>
                </tr>
                <tr>
                  <th>Completed</th>
                  <td id="job-completed"></td>
                </tr>
                <tr>
                  <th>Watcher ID</th>
                  <td id="job-watcher-id"></td>
                </tr>
                <tr>
                  <th>Demands</th>
                  <td id="job-demands"></td>
                </tr>
              </tbody>
            </table>
          </div>

          <div class="tab-content" id="parameters-tab" style="display: none;">
            <div id="job-parameters">
              <div class="loading-message small">
                <div class="loading-spinner"></div>
                <span>Loading parameters...</span>
              </div>
            </div>
          </div>

          <div class="tab-content" id="files-tab" style="display: none;">
            <div class="files-container">
              <div class="files-header">
                <h4>Associated Files</h4>
                <button class="action-button secondary refresh-files">
                  <i class="fas fa-sync-alt"></i>
                  Refresh
                </button>
              </div>
              <div class="table-container">
                <table class="data-table files-table">
                  <thead>
                    <tr>
                        <th data-sort="status">Status</th>
                        <th data-sort="file_name">File Name</th>
                        <th data-sort="file_path">File Path</th>
                    </tr>
                  </thead>
                  <tbody id="job-files-tbody">
                    <tr>
                      <td colspan="4" class="loading-message">
                        <div class="loading-spinner"></div>
                        <span>Loading files...</span>
                      </td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="modal-footer">
      <button class="action-button secondary" id="close-job-details-btn">Close</button>
      <button class="action-button danger" id="stop-job-btn" style="display: none;">Stop Job</button>
    </div>
  </div>
</div>
</div>
<script>
// Enhanced script for highlighting jobs
document.addEventListener('DOMContentLoaded', () => {
  const urlParams = new URLSearchParams(window.location.search);
  const jobId = urlParams.get('job_id');
  // Start progress updates for any running jobs when the page loads
    const runningJobs = document.querySelectorAll('tr[data-status="running"]');
    runningJobs.forEach(job => {
        const jobId = job.getAttribute('data-job-id');
        if (jobId) {
            updateJobStatus(jobId);
        }
    });


  // Try to highlight the job row multiple times to handle any race conditions
  // or timing issues with asynchronous loading
  if (jobId) {
    // Try immediately
    highlightJob(jobId);

    // Try again after a short delay to ensure DOM is updated
    setTimeout(() => highlightJob(jobId), 300);

    // Try once more after the page is fully loaded
    setTimeout(() => highlightJob(jobId), 1000);
  }

  function highlightJob(id) {
    const jobRow = document.querySelector(`.job-row[data-job-id="${id}"]`);
    if (jobRow) {
      // Remove any existing highlights first
      document.querySelectorAll('.job-row.highlighted').forEach(row => {
        row.classList.remove('highlighted');
      });

      // Add highlight to this row
      jobRow.classList.add('highlighted');

      // Scroll the row into view
      jobRow.scrollIntoView({ behavior: 'smooth', block: 'center' });

      console.log(`Job #${id} highlighted successfully`);
    } else {
      console.warn(`Couldn't find job row for ID ${id}`);
    }
  }
});

// If we have the highlightSelectedJob function available (from jobs.js module)
// use it when the page refreshes via AJAX
if (typeof window.highlightSelectedJob === 'function') {
  document.addEventListener('DOMContentLoaded', () => {
    const refreshBtn = document.getElementById('refresh-jobs');
    if (refreshBtn) {
      refreshBtn.addEventListener('click', () => {
        // After refresh completes, re-apply highlighting
        setTimeout(window.highlightSelectedJob, 500);
      });
    }
  });
}


</script>

{% endblock %}